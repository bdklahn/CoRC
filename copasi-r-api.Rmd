---
title: "Copasi R API"
output: html_notebook
---

# Initial Setup for MacOS

## Initial checkout

Initial setup of the Copasi R API requires checking out the copasi-r-api repositiory at an appropriate location.

Use this command to clone the repository
```{bash}
git clone --recursive git@github.com:jonasfoe/copasi-r-api.git
```

If the repository is already cloned, use
```{bash}
git submodule update --init --recursive
```

This step makes sure the Copasi sources are cloned.

## Dependencies for compilation of the Copasi sources

The following dependencies exist for compiling the sources:

cmake, swig

Cosider using homebrew for MacOS to install them
```{bash}
brew install cmake swig
```

## Fixing Copasi source

This removes a Mac-specific error during the build process but might not fully function as intended either.
It also incorporates some changes to R specific modifications during the build process.

```{bash}
cd copasi-dev/COPASI/
git apply ../fix-corefoundation-library.patch
cd ../../
```

## Compiling Copasi dependencies

```{bash}
cd copasi-dev/copasi-dependencies/
./createOSX.sh
cd ../../
```

## Compiling Copasi from source

```{bash}
cd copasi-dev/
mkdir build_copasi_r_bindings
cd build_copasi_r_bindings/
cmake -DBUILD_GUI=OFF -DBUILD_SE=OFF -DENABLE_R=ON -DCOPASI_DEPENDENCY_DIR=../copasi-dependencies/bin ../COPASI
make
cd ../../
```

# Loading the COPASI-R-API

```{r}
dyn.load(paste0("copasi-dev/build_copasi_r_bindings/copasi/bindings/R/COPASI", .Platform$dynlib.ext))
source("copasi-dev/build_copasi_r_bindings/copasi/bindings/R/COPASI.R")
cacheMetaData(1)
```

## Fixing enumeration wrappers

For platform independece, I have removed a cmake script that fixes enumeration wrappers during the build process.
These wrappers are now overwritten in R after the fact to restore functionality.

```{r}
enumToInteger <- function(name,type) {
    if (is.character(name)) {
        ans <- as.integer(get0(paste0(".__E__", type))[name])
        if (length(ans) == 0) {ans <- as.integer(get(paste0(".__E__", substr(type, 3, nchar(type))))[name])}
        if (is.na(ans)) {warning("enum not found ", name, " ", type)}
        ans
    }
}
  
enumFromInteger <- function(i,type) {
    itemlist <- get0(paste0(".__E__", type))
    if (length(itemlist) == 0) {itemlist <- get(paste0(".__E__", substr(type, 3, nchar(type))))}
    names(itemlist)[match(i, itemlist)]
}
```

The API is now loaded.
