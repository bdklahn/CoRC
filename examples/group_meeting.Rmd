---
title: "Group Meeting"
output:
  html_document: default
  html_notebook: default
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "../")
library(tidyverse, warn.conflicts = FALSE)
```

# Initialize the API

```{r}
source("copasi_funs.R")
```

# Load a model cps file

```{r, results='hide'}
model <- loadModel("examples/brusselator_1.cps")
```

This will load the following model:

```{bash, eval=FALSE}
/Applications/COPASI/CopasiUI.app/Contents/MacOS/CopasiUI examples/brusselator_1.cps &
```

# Capabilities of the API

Get species as R data frame:

```{r}
species <- getSpecies()
species
```

Edit the data frame and submit as new parameters:

```{r}
species %>%
    dplyr::mutate(
        concentration = concentration * 2
    ) %>%
    dplyr::arrange(name) %>%
    setSpecies() %>%
    invisible()
getSpecies()
saveCPS("examples/brusselator_1_new.cps", overwrite = TRUE)
```

The new copasi file has a rearranged parameter set:

```{bash, eval=FALSE}
/Applications/COPASI/CopasiUI.app/Contents/MacOS/CopasiUI examples/brusselator_1_new.cps &
```

Run a time-course simulation and get a data frame ready for plotting.

```{r}
tc <- runTimecourse(100)
tc
tc %>%
    ggplot(aes(x = Time)) +
    geom_line(aes(y = X, color = "X")) +
    geom_line(aes(y = Y, color = "Y")) +
    labs(Y = "Concentration (a.u.)", color = "Metabolite")
```

# Issues with this approach

## Settings defined in .cps files

```{r, results='hide'}
model1 <- loadModel("examples/brusselator_1.cps")
model2 <- loadModel("examples/brusselator_2.cps")
```

This loads these 2 models:

```{r}
print(model1)
print(model2)
```

```{bash, eval=FALSE}
/Applications/COPASI/CopasiUI.app/Contents/MacOS/CopasiUI examples/brusselator_1.cps &
```
```{bash, eval=FALSE}
/Applications/COPASI/CopasiUI.app/Contents/MacOS/CopasiUI examples/brusselator_2.cps &
```

The models are idential but they have different options set for time-course simulation in the .cps file.

```{r}
tc1 <- runTimecourse(100, datamodel = model1)
tc2 <- runTimecourse(100, datamodel = model2)
tc1 %>%
    ggplot(aes(x = Time)) +
    geom_line(aes(y = X, color = "X")) +
    geom_line(aes(y = Y, color = "Y")) +
    labs(y = "Concentration (a.u.)", color = "Metabolite")
tc2 %>%
    ggplot(aes(x = Time)) +
    geom_line(aes(y = X, color = "X")) +
    geom_line(aes(y = Y, color = "Y")) +
    labs(y = "Concentration (a.u.)", color = "Metabolite")
```

Should the settings in the copasi file be ignored or should the be the default parameters?

## All model object are just references to Copasi

You can unload any model from Copasi but the you don't lose the reference in R

```{r}
print(model)
unloadModel(model)
model
```

These commands will cause R to crash

```{r, eval=FALSE}
model$getModel()
print(model)
```

Maybe I can include SBML data as a fallback:

```{r, results='hide'}
model <- loadModel("examples/brusselator_1.cps")
```

```{r}
list(
    model = model,
    smbl = model$exportSBMLToString(sbmlLevel = 3, sbmlVersion = 1)
)
```
