---
title: "Compile Copasi R Bindings From Source"
output:
  html_document:
    toc: yes
  html_notebook: default
---

# Initial checkout

Use this command to clone the repository:

```{bash, eval=FALSE}
git clone https://github.com/jpahle/CoRC
```

Alternatively via ssh:
```{bash, eval=FALSE}
git clone git@github.com:jpahle/CoRC.git
```

Once the repository is cloned, use:

```{bash, eval=FALSE}
git submodule update --init --recursive
```

This step makes sure the Copasi sources are cloned.

# Dependencies for compilation of the copasi sources

## macOS

The following dependencies exist for compiling the sources:

xcode command line tools

```{bash, eval=FALSE}
xcode-select --install
```

Cosider using homebrew for macOS to install other dependencies:

cmake, swig, gawk, wget, astyle

```{bash, eval=FALSE}
brew install cmake swig gawk wget astyle
```

## Windows:

Use chocolatey to install:
```
choco install -y visualstudio2017community visualstudio2017-workload-nativedesktop ninja cmake.portable
```

Manually download swig and put it in: development\copasi-source\copasi-dependencies\swigwin\
Manually get the Rlib (Rlib.lib) files for your current R Version and put it in: development\copasi-source\r-3.4.1-import-lib\x64\
Use the cmd prompt.

# Compiling copasi dependencies

## macOS

```{bash, eval=FALSE}
cd development/copasi-source/copasi-dependencies/
./createOSX-qt5.sh
cd ../../../
```

## Windows:

run:
```
cd development\copasi-source\copasi-dependencies\
.\createX86_vs15_x64_release.bat
cd ..\..\..\
```

# Compiling copasi from source

## macOS

```{bash, eval=FALSE}
cd development/copasi-source/COPASI/
./gitTools/UpdateCopasiVersion
cd ../
mkdir build_copasi_r_bindings
cd build_copasi_r_bindings/
cmake -DBUILD_GUI=OFF -DBUILD_SE=OFF -DENABLE_R=ON -DCOPASI_DEPENDENCY_DIR=../copasi-dependencies/bin ../COPASI
make
cd ../../../
```

## Windows

run:
```
cd development\copasi-source\
mkdir build_copasi_r_bindings
cd build_copasi_r_bindings\
call "%ProgramFiles(x86)%\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat" x86_amd64
cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=cl -DCMAKE_CXX_COMPILER=cl -DBUILD_GUI=OFF -DBUILD_SE=OFF -DENABLE_R=ON -DCOPASI_DEPENDENCY_DIR="../copasi-dependencies/bin_vs15_x64_Release" -DSWIG_EXECUTABLE="../swigwin/swig.exe" -DR_INCLUDE_DIRS="C:/Program Files/R/R-3.4.1/include" -DR_INTERPRETER="C:/Program Files/R/R-3.4.1/bin/R.exe" -DR_LIB="../r-3.4.1-import-lib/x64/Rlib" ../COPASI
ninja
```

# (Optionally) Update and rebuild all for release

## macOS

```{bash, eval=FALSE}
cd development/copasi-source/
rm -r build_copasi_r_bindings/
cd copasi-dependencies/
rm -r tmp/ bin/
git pull
./createOSX-qt5.sh
cd ../COPASI/
git pull upstream develop
./gitTools/UpdateCopasiVersion
cd ../
mkdir build_copasi_r_bindings
cd build_copasi_r_bindings/
cmake -DBUILD_GUI=OFF -DBUILD_SE=OFF -DENABLE_R=ON -DCOPASI_DEPENDENCY_DIR=../copasi-dependencies/bin ../COPASI
make
cd ../../../
```

# (Optionally) Build GUI

## macOS

Cosider using homebrew for macOS intall qt5:

```{bash, eval=FALSE}
brew install qt5
```

Build dependencies:

```{bash, eval=FALSE}
cd development/copasi-source/copasi-dependencies/
export Qt5_Dir=/usr/local/opt/qt/lib/cmake/Qt5
./createOSX-qt5.sh
cd ../../../
```

Build GUI:

```{bash, eval=FALSE}
cd development/copasi-source/build_copasi_r_bindings/
export Qt5_Dir=/usr/local/opt/qt/lib/cmake/Qt5
cmake -DBUILD_GUI=ON -DSELECT_QT=Qt5 -DQT5_USE_WEBENGINE=ON .
make
cd ../../../
```

# Copying the relevant file into the package repository

```{r, eval=FALSE}
source("../development/update-swig-in-package.R", chdir = TRUE)
```

# Installing the package

```{r, eval=FALSE}
devtools::install("..")
```

# Getting the current hash for the binary (update it in CoRC.R)

```{r, eval=FALSE}
digest::digest(paste0("copasi-source/build_copasi_r_bindings/copasi/bindings/R/COPASI", .Platform$dynlib.ext), algo = "sha256", file = TRUE)
```

