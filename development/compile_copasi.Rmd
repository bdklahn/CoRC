---
title: "Compile Copasi R Bindings From Source"
output:
  html_document:
    toc: yes
  html_notebook: default
---

# Initial checkout

Use this command to clone the repository:

```{bash, eval=FALSE}
git clone https://github.com/jpahle/CoRC
```

Alternatively via ssh:
```{bash, eval=FALSE}
git clone git@github.com:jpahle/CoRC.git
```

# Pull sources

Once the repository is cloned, make sure the relevant revision of the Copasi sources is available.

Quick:

```{bash, eval=FALSE}
cd copasi-source/
./copasi_sources_copy.sh
cd ../
```

Full clone:

```{bash, eval=FALSE}
cd copasi-source/
./copasi_sources_clone.sh
cd ../
```

Windows:

```
cd development\copasi-source\
.\copasi_sources_clone.ps1
cd ..\..\
```

# macOS

## Dependencies for compilation of the copasi sources

The following dependencies exist for compiling the sources:

xcode command line tools

```{bash, eval=FALSE}
xcode-select --install
```

Consider using homebrew for macOS to install other dependencies:

```{bash, eval=FALSE}
brew install cmake swig
```

## Compiling copasi dependencies

```{bash, eval=FALSE}
cd development/copasi-source/copasi-dependencies/
rm -rf tmp_darwin_x64/ bin_darwin_x64/
BUILD_DIR=${PWD}/tmp_darwin_x64 \
	INSTALL_DIR=${PWD}/bin_darwin_x64 \
	./createOSX-qt5.sh
cd ../../../
```

## Compiling copasi from source

```{bash, eval=FALSE}
cd development/copasi-source/
cp CopasiVersion.h COPASI/copasi/
mkdir -p corc_darwin_x64/
cd corc_darwin_x64/
cmake \
  -DCMAKE_BUILD_TYPE=Release \
  -DBUILD_GUI=OFF \
  -DBUILD_SE=OFF \
  -DENABLE_R=ON \
  -DR_USE_DYNAMIC_LOOKUP=ON \
  -DCOPASI_DEPENDENCY_DIR=../copasi-dependencies/bin_darwin_x64/ \
  ../COPASI/
make binding_r_lib

cd ../
mkdir -p libs/
cp corc_darwin_x64/copasi/bindings/R/COPASI.so libs/COPASI_darwin_x86_64.so
cp corc_darwin_x64/copasi/bindings/R/COPASI.so libs/COPASI.so
cp corc_darwin_x64/copasi/bindings/R/COPASI.R libs/swig_wrapper.R
cd ../../
```

## (Optionally) rebuild all for release

```{bash, eval=FALSE}
cd development/copasi-source/

cd copasi-dependencies/
rm -rf tmp_darwin_x64/ bin_darwin_x64/
BUILD_DIR=${PWD}/tmp_darwin_x64 \
	INSTALL_DIR=${PWD}/bin_darwin_x64 \
	./createOSX-qt5.sh
cd ..

cp CopasiVersion.h COPASI/copasi/
rm -rf corc_darwin_x64/
mkdir corc_darwin_x64/
cd corc_darwin_x64/
cmake \
  -DCMAKE_BUILD_TYPE=Release \
  -DBUILD_GUI=OFF \
  -DBUILD_SE=OFF \
  -DENABLE_R=ON \
  -DR_USE_DYNAMIC_LOOKUP=ON \
  -DCOPASI_DEPENDENCY_DIR=../copasi-dependencies/bin_darwin_x64/ \
  ../COPASI/
make binding_r_lib

cd ../
mkdir -p libs/
cp corc_darwin_x64/copasi/bindings/R/COPASI.so libs/COPASI_darwin_x86_64.so
cp corc_darwin_x64/copasi/bindings/R/COPASI.so libs/COPASI.so
cp corc_darwin_x64/copasi/bindings/R/COPASI.R libs/swig_wrapper.R
cd ../../
```

## (Optionally) Build GUI

Instructions build on top of already compiled R bindings.

Cosider using homebrew for macOS intall qt5:

```{bash, eval=FALSE}
brew install qt5
```

Build dependencies:

```{bash, eval=FALSE}
cd development/copasi-source/copasi-dependencies/
export Qt5_Dir=/usr/local/opt/qt/lib/cmake/Qt5
BUILD_DIR=${PWD}/tmp_darwin_x64 \
	INSTALL_DIR=${PWD}/bin_darwin_x64 \
  ./createOSX-qt5.sh
cd ../../../
```

Build GUI:

```{bash, eval=FALSE}
cd development/copasi-source/build_copasi_r_binding/
export Qt5_Dir=/usr/local/opt/qt/lib/cmake/Qt5
cmake \
  -DBUILD_GUI=ON \
  -DSELECT_QT=Qt5 \
  -DQT5_USE_WEBENGINE=ON \
  .
make
cd ../../../
```

# Windows

## Dependencies for compilation of the copasi sources

Use chocolatey to install:

```
choco install -y visualstudio2017community visualstudio2017-workload-nativedesktop ninja cmake.portable wget
```

Manually download swig and put it in: development\copasi-source\copasi-dependencies\swigwin\
Manually get the Rlib (Rlib.lib) files for your current R Version and put it in e.g.: development\copasi-source\r-3.4.1-import-lib\x64\

Use the cmd prompt.

## Compiling copasi dependencies

run:
```
cd development\copasi-source\copasi-dependencies\
.\createX86_vs15_x64_release.bat
cd ..\..\..\
```

## Compiling copasi from source

run:
```
cd development\copasi-source\
cp CopasiVersion.h COPASI\copasi\
mkdir corc_windows_x64\
cd corc_windows_x64\
call "%ProgramFiles(x86)%\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat" x86_amd64
cmake -G Ninja ^
  -DCMAKE_BUILD_TYPE=Release ^
  -DCMAKE_C_COMPILER=cl ^
  -DCMAKE_CXX_COMPILER=cl ^
  -DBUILD_GUI=OFF ^
  -DBUILD_SE=OFF ^
  -DENABLE_R=ON ^
  -DCOPASI_DEPENDENCY_DIR="../copasi-dependencies/bin_vs15_x64_Release/" ^
  -DSWIG_EXECUTABLE="../swigwin/swig.exe" ^
  -DR_INCLUDE_DIRS="C:/Program Files/R/R-3.4.2/include/" ^
  -DR_INTERPRETER="C:/Program Files/R/R-3.4.2/bin/R.exe" ^
  -DR_LIB="../r-3.4.1-import-lib/x64/Rlib" ^
  ../COPASI/
ninja binding_r_lib

cd ..\
mkdir libs\
cp corc_windows_x64\copasi\bindings\R\COPASI.dll libs\COPASI_windows_x86_64.dll
cp corc_windows_x64\copasi\bindings\R\COPASI.dll libs\COPASI.dll
cp corc_windows_x64\copasi\bindings\R\COPASI.R libs\swig_wrapper.R
cd ..\..\
```

# linux

Install docker CE and get docker permissions for your user.

## Full

```{bash, eval=FALSE}
cd development/copasi-source/
./d_build_linux_clean.sh
cd ../../
```

## Quick

Requires copasi-dependencies to be compiled already.

```{bash, eval=FALSE}
cd development/copasi-source/
./d_build_linux_x64_quick.sh
cd ../../
```

# Copying the relevant file into the package repository

Will also patch the swig wrapper (COPASI.R) as per patch-swig-wrapper.R

```{r, eval=FALSE}
source("../development/update-swig-in-package.R", chdir = TRUE)
```

# Installing the package

```{r, eval=FALSE}
devtools::install("..")
```

# Getting the current hash for the binary (update it in CoRC.R)

```{r, eval=FALSE}
for (file in list.files("copasi-source/libs", full.names = T))
  cat(file, "\t", digest::digest(file, algo = "sha256", file = TRUE), "\n")
```

