---
title: "CoRC - the Copasi R Connector"
author: "Jonas Förster & Jürgen Pahle"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# <img src="logo/CoRC.svg" alt="CoRC logo" width="200"> --- the <b>Co</b>pasi <b>R</b> <b>C</b>onnector

CoRC, the Copasi R Connector, links the Complex Pathway Simulator COPASI ([copasi.org](http://copasi.org)) and the (statistical) programming environment R ([r-project.org](http://r-project.org)). It provides easy access to the powerful biochemical model editing, simulation and analysis backend of Copasi from the convenient R command line interface. This allows the user to develop elaborate scripts and workflows for analyses that would require a great deal of tedious manual work otherwise. These scripts can then be run interactively from the R command line interface or send to cluster or cloud facilities for more demanding calculations.

CoRC features:

* high-level API for Copasi in the R language
* ...

You can get more information or download CoRC from <https://github.com/jpahle/CoRC/>.


# Installation

You can install CoRC from [github](http://github.com) with:

```{r gh-installation, eval = FALSE}
# install.packages("devtools")
devtools::install_github("jpahle/CoRC")
CoRC::getCopasi()
```

CoRC comes with the Artistic License 2.0. By using CoRC you agree to this license.


# Examples, case-studies and workflows

```{r, message=FALSE}
library(tidyverse)
library(CoRC)
library(parallel)

# helper to run tasks in parallel on all cores
mapInParallel <- function(data, fun, ..., .prep = {}) {
  cl <- makeCluster(detectCores())
  clusterCall(cl = cl, fun = eval, .prep, env = .GlobalEnv)
  ret <- clusterApplyLB(cl = cl, x = parallel:::splitList(data, length(data)), fun = lapply, fun, ...)
  stopCluster(cl)
  flatten(ret)
}
```

## 3D trajectory plot of calcium model

```{r, fig.height=6, fig.width=8}
# Load Ca Model
suppressWarnings(loadSBML("http://www.ebi.ac.uk/biomodels-main/download?mid=BIOMD0000000329"))

# Run 24 sec (2 Periods)
runTimeCourse(24, intervals = 10000) %>%
  set_tidy_names(T, T) %>%
  plotly::plot_ly(
    type = "scatter3d",
    mode = "lines",
    x = ~ G.alpha,
    y = ~ activePLC,
    z = ~ Calcium,
    color = ~ Time
  )
```

## 3D trajectory plot of calcium model

```{r, fig.height=6, fig.width=8}
# Run 500 stochastic time series possibly in parallel
# loadModel("https://raw.githubusercontent.com/copasi/condor-copasi/master/examples/stochastic_test.cps")
# tcs <- 1:500 %>% map(~ runTimeCourse())
tcs <- 1:500 %>% mapInParallel(
  .prep = quote({
    library(CoRC)
    loadModel("https://raw.githubusercontent.com/copasi/condor-copasi/master/examples/stochastic_test.cps")
  }),
  function(x) {runTimeCourse()}
)

tcs_timepoints <-
  tibble(
    Time = tcs %>% first() %>% .$Time,
    a = tcs %>% map("a") %>% transpose() %>% map(flatten_dbl),
    b = tcs %>% map("b") %>% transpose() %>% map(flatten_dbl),
    c = tcs %>% map("c") %>% transpose() %>% map(flatten_dbl),
    a_mean = a %>% map_dbl(mean),
    b_mean = b %>% map_dbl(mean),
    c_mean = c %>% map_dbl(mean),
    a_sd = a %>% map_dbl(sd),
    b_sd = b %>% map_dbl(sd),
    c_sd = c %>% map_dbl(sd)
  )

tcs_timepoints %>%
  ggplot(aes(x = Time)) +
  geom_ribbon(aes(ymin = a_mean - a_sd, ymax = a_mean + a_sd, fill = "a"), alpha = 0.25) +
  geom_ribbon(aes(ymin = b_mean - b_sd, ymax = b_mean + b_sd, fill = "b"), alpha = 0.25) +
  geom_ribbon(aes(ymin = c_mean - c_sd, ymax = c_mean + c_sd, fill = "c"), alpha = 0.25) +
  geom_line(aes(y = a_mean, color = "a")) +
  geom_line(aes(y = b_mean, color = "b")) +
  geom_line(aes(y = c_mean, color = "c")) +
  guides(fill = "none") +
  labs(
    x = paste0("Time (", getTimeUnit(), ")"),
    y = paste0("Concentration (", getQuantityUnit(), ")"),
    color = "Species"
  )
```

