---
title: "CoRC - the Copasi R Connector"
author: "Jonas Förster & Jürgen Pahle"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

# <img src="logo/CoRC.svg" alt="CoRC logo" width="200"> --- the <b>Co</b>pasi <b>R</b> <b>C</b>onnector

CoRC, the Copasi R Connector, links the Complex Pathway Simulator COPASI ([copasi.org](http://copasi.org)) and the (statistical) programming environment R ([r-project.org](http://r-project.org)). It provides easy access to the powerful biochemical model editing, simulation and analysis backend of Copasi from the convenient R command line interface. This allows the user to develop elaborate scripts and workflows for analyses that would require a great deal of tedious manual work otherwise. These scripts can then be run interactively from the R command line interface or send to cluster or cloud facilities for more demanding calculations.

CoRC features:

* high-level API for Copasi in the R language
* ...

You can get more information or download CoRC from <https://github.com/jpahle/CoRC/>.


# Installation

You can install CoRC from [github](http://github.com) with:

```{r gh-installation, eval = FALSE}
# install.packages("devtools")
devtools::install_github("jpahle/CoRC")
CoRC::getCopasi()
```

CoRC comes with the Artistic License 2.0. By using CoRC you agree to this license.


# Examples, case-studies and workflows

```{r, message=FALSE}
library(tidyverse)
library(parallel)
library(CoRC)

# helper to run tasks in parallel on all cores
mapInParallel <- function(data, fun, ..., .prep = {}) {
  cl <- makeCluster(detectCores())
  clusterCall(cl = cl, fun = eval, .prep, env = .GlobalEnv)
  ret <- clusterApplyLB(cl = cl, x = parallel:::splitList(data, length(data)), fun = lapply, as_mapper(fun), ...)
  stopCluster(cl)
  flatten(ret)
}
```

## 3D trajectory plot of calcium model

```{r, fig.height=6, fig.width=8, warning=FALSE}
# Load Ca Model
loadSBML("http://www.ebi.ac.uk/biomodels-main/download?mid=BIOMD0000000329")
# Run 24 sec (2 Periods)
setTimeCourseSettings(24, intervals = 10000)

timeseries <- list(
  deterministic = runTimeCourse(),
  stochastic = runTimeCourse(method = "directMethod")
)

plots <- timeseries %>% map(~
  .x %>%
    set_tidy_names(T, T) %>%
    plotly::plot_ly(
      type = "scatter3d",
      mode = "lines",
      x = ~ G.alpha,
      y = ~ activePLC,
      z = ~ Calcium,
      color = ~ Time
    )
)

unloadModel()

plots$deterministic
plots$stochastic
```

## Statistics of reapeated stochastic simulations

```{r, fig.height=6, fig.width=8}
# Run 1000 stochastic time series possibly in parallel
loadModel("https://raw.githubusercontent.com/copasi/condor-copasi/master/examples/stochastic_test.cps")
# timeseries <- 1:1000 %>% map(~ runTimeCourse())
timeseries <- 1:1000 %>% mapInParallel(
  .prep = quote({
    library(CoRC)
    loadModel("https://raw.githubusercontent.com/copasi/condor-copasi/master/examples/stochastic_test.cps")
  }),
  ~ runTimeCourse()
)

plot <- timeseries %>%
  bind_rows() %>%
  gather(species, concentration, a, b, c) %>%
  ggplot(aes(x = Time, y = concentration, group = species)) +
  stat_summary(aes(fill = species), geom = "ribbon", fun.data = mean_sdl, fun.args = 1, alpha = 0.25) +
  stat_summary(aes(color = species), geom = "line", fun.y = mean) +
  guides(fill = "none") +
  labs(
    x = paste0("Time (", getTimeUnit(), ")"),
    y = paste0("Concentration (", getQuantityUnit(), ")"),
    color = "Species"
  )

unloadModel()

plot %>% plotly::ggplotly()
```

## Parameter scan

```{r}
loadSBML("https://www.ebi.ac.uk/biomodels-main/download?mid=BIOMD0000000068")
setSteadyStateSettings(calculateJacobian = FALSE, performStabilityAnalysis = FALSE)

cysteine_ref <- species("Cysteine")
adomed_ref <- species("adenosyl")

scan <- cross_df(
  list(
    cysteine = 0.3 * 10 ^ seq(0, 3, length.out = 6),
    adomed = seq(0, 100, length.out = 51)
  )
)

scan <- 
  scan %>%
  mutate(
    ss_fluxes = pmap(., function(cysteine, adomed) {
      setSpecies(key = cysteine_ref, initial.concentration = cysteine)
      setSpecies(key = adomed_ref, initial.concentration = adomed)
      ss <- runSteadyState()
      stopifnot(ss$result == "found")
      ss$reactions$concentration.flux
    }),
    CGS = ss_fluxes %>% map_dbl(2),
    TS = ss_fluxes %>% map_dbl(3)
  )

plot <- scan %>%
  gather(reaction, flux, CGS, TS) %>%
  ggplot(aes(x = adomed, y = flux, group = reaction, tt_cys = cysteine)) +
  geom_point(aes(color = reaction)) +
  labs(
    x = paste0("Abomed (", getQuantityUnit(), ")"),
    y = paste0("Flux (", getQuantityUnit(), " / ", getTimeUnit(), ")"),
    color = "Species"
  )

unloadModel()

plot %>% plotly::ggplotly(tooltip = c("tt_cys", "x", "y"))
```

```{r}
loadSBML("https://www.ebi.ac.uk/biomodels-main/download?mid=BIOMD0000000068")

scan <-
  1:10000 %>%
  mapInParallel(
    .prep = quote({
      library(CoRC)
      loadSBML("https://www.ebi.ac.uk/biomodels-main/download?mid=BIOMD0000000068")
      setSteadyStateSettings(calculateJacobian = FALSE, performStabilityAnalysis = FALSE)
      cysteine_ref <- species("Cysteine")
      adomed_ref <- species("adenosyl")
    }),
    ~ {
      cysteine <- 0.3 * 10 ^ runif(1L, min = 0, max = 3)
      # cysteine <- runif(1L, min = 0.3, max = 300)
      adomed <- runif(1L, min = 0, max = 100)
      setSpecies(
        key = c(cysteine_ref, adomed_ref),
        initial.concentration = c(cysteine, adomed)
      )
      ss <- runSteadyState()
      stopifnot(ss$result == "found")
      list(
        cysteine = cysteine,
        adomed = adomed,
        CGS = ss$reactions$concentration.flux[2],
        TS = ss$reactions$concentration.flux[3]
      )
    }
  ) %>%
  bind_rows()

plot <- scan %>%
  gather(reaction, flux, CGS, TS) %>%
  ggplot(aes(x = adomed, y = flux, group = reaction, tt_cys = cysteine)) +
  geom_point(aes(color = reaction)) +
  labs(
    x = paste0("Abomed (", getQuantityUnit(), ")"),
    y = paste0("Flux (", getQuantityUnit(), " / ", getTimeUnit(), ")"),
    color = "Species"
  )

unloadModel()

plot %>% plotly::ggplotly(tooltip = c("tt_cys", "x", "y"))
```

