---
title: "Issues"
author: "Jonas Förster & Jürgen Pahle"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Issues}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  out.width = "100%",
  warning = FALSE,
  message = FALSE
)
set.seed(1)
```

# Initial Setup

```{r setup}
library(CoRC)
loadExamples(1)
```

# Quicklist

* getwd() and copasi$getReferenceDirectory() are not in sync
* some S3 classes should have reconstruct functions (hadley/sloop)
* getListOfPossibleFunctions only returns bare pointer
* Crash in time course using stochastic algorithms? http://tracker.copasi.org/show_bug.cgi?id=2495
* Are tasks always there?
* Can't abort running tasks
* Check if installation can be as easy as with stringi package
* See if I can switch to stictly verbose species keys ('A{comp}' instead of 'A')

# Function naming is lacking a cohesive concept

Quantity accessors are named:

```{r, eval=FALSE}
getSpecies()
setSpecies()
getGlobalQuantities()
setGlobalQuantities()
setParameters()
```

Task related functions are named:

```{r, eval=FALSE}
runTimeCourse()
runSteadyState()
runParameterEstimation()
setTimeCourseSettings()
setSteadyStateSettings()
setParameterEstimationSettings()
```

There are further functions which with awkward names:

```{r, eval=FALSE}
# Adds FitItem to parameter estimation task
# No relation to setParameters(), which handles reaction parameters
addParameterEstimationParameter()
```

Naming so far has been based on the desire to stay as close to the GUI as possible.
It's probably time to define a cohesive concept.

# No option to cancel long running tasks

The r-session locks up when waiting for C calls to return.
I have no idea how I can enable interactive canceling of tasks.
This seems like it could get frustrating because people probably start endless tasks frequently.

# Checking validity of quantity unit doesn't work

```{r}
CUnit <- CoRC:::CUnit
```

The CUnit class can be used for testing if user specified input is valid

```{r, results="hide"}
ms <- CUnit("ms")
s <- CUnit("ms * 1e3")
mmol <- CUnit("mmol")
mol <- CUnit("mmol * 1e3")
mMol <- CUnit("mMol")

ms$buildExpression()
s$buildExpression()
mmol$buildExpression()
mol$buildExpression()
mMol$buildExpression()
```

CUnit$getExpression() shows what Copasi makes of the input.

```{r}
ms$getExpression()
s$getExpression()
mmol$getExpression()
mol$getExpression()
mMol$getExpression()
```

CUnit$isUnitType("\<type\>") will return useful information on validity for all but "quantity".

```{r}
ms$isUnitType("time")

s$isUnitType("time")
s$isUnitType("quantity")

mmol$isUnitType("quantity")

mol$isUnitType("quantity")
mol$isUnitType("time")
mol$isUnitType("volume")
mol$isUnitType("area")
mol$isUnitType("length")

mMol$isUnitType("quantity")
```

# Saving .cps loses experimental data

I commonly want to save a .cps to a tmp folder but when I do that experimental data paths will fail.

```{r}
# Load example which has experimental data.
datamodel <- loadExamples(4)[[1]]

fitproblem <- as(datamodel$getTask("Parameter Estimation")$getProblem(), "_p_CFitProblem")
filenames <- fitproblem$getExperimentSet()$getFileNames()
```

The filenames are in the correct folder.

```{r}
filenames
file.exists(filenames)
```

Now I will save the model into a tmp folder.

```{r}
file <- tempfile(fileext = ".cps")
saveModel(file)
unloadModel()

datamodel <- loadModel(file)
fitproblem <- as(datamodel$getTask("Parameter Estimation")$getProblem(), "_p_CFitProblem")
filenames <- fitproblem$getExperimentSet()$getFileNames()
```

The filenames are now supposedly in the folder where the .cps was saved but there they don't exist.

```{r}
filenames
file.exists(filenames)
```

```{r}
unloadModel()
invisible(file.remove(file))
```
