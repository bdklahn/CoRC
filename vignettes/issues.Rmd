---
title: "Issues"
author: "Jonas Förster & Jürgen Pahle"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Issues}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  out.width = "100%",
  warning = FALSE,
  message = FALSE
)
set.seed(1)
```

# Initial Setup

```{r setup}
library(CoRC)
loadExamples(1)
```

# Quicklist

Todo:

* Add more COPASI tasks
* Possibly parallel helper function (saveModelToString, load on cluster, evaluate given expressions)
* (Internal) Code marked with 'TODO' for minor problems
* Check if installation can be as easy as with stringi package
* Consider only ever using setcompileflag instead of compiling
* getListOfPossibleFunctions only returns bare pointer

Issues:

* getwd() and copasi$getReferenceDirectory() are not in sync
* some S3 classes should have reconstruct functions (hadley/sloop)

# Checking validity of quantity unit doesn't work

```{r}
CUnit <- CoRC:::CUnit
```

The CUnit class can be used for testing if user specified input is valid

```{r, results="hide"}
ms <- CUnit("ms")
s <- CUnit("ms * 1e3")
mmol <- CUnit("mmol")
mol <- CUnit("mmol * 1e3")
mMol <- CUnit("mMol")

ms$buildExpression()
s$buildExpression()
mmol$buildExpression()
mol$buildExpression()
mMol$buildExpression()
```

CUnit$getExpression() shows what COPASI makes of the input.

```{r}
ms$getExpression()
s$getExpression()
mmol$getExpression()
mol$getExpression()
mMol$getExpression()
```

CUnit$isUnitType("\<type\>") will return useful information on validity for all but "quantity".

```{r}
ms$isUnitType("time")

s$isUnitType("time")
s$isUnitType("quantity")

mmol$isUnitType("quantity")

mol$isUnitType("quantity")
mol$isUnitType("time")
mol$isUnitType("volume")
mol$isUnitType("area")
mol$isUnitType("length")

mMol$isUnitType("quantity")
```

# Saving .cps loses experimental data

I commonly want to save a .cps to a tmp folder but when I do that experimental data paths will fail.

```{r}
# Load example which has experimental data.
datamodel <- loadExamples(4)[[1]]

fitproblem <- as(datamodel$getTask("Parameter Estimation")$getProblem(), "_p_CFitProblem")
filenames <- fitproblem$getExperimentSet()$getFileNames()
```

The filenames are in the correct folder.

```{r}
filenames
file.exists(filenames)
```

Now I will save the model into a tmp folder.

```{r}
file <- tempfile(fileext = ".cps")
saveModel(file)
unloadModel()

datamodel <- loadModel(file)
fitproblem <- as(datamodel$getTask("Parameter Estimation")$getProblem(), "_p_CFitProblem")
filenames <- fitproblem$getExperimentSet()$getFileNames()
```

The filenames are now supposedly in the folder where the .cps was saved but there they don't exist.

```{r}
filenames
file.exists(filenames)
```

```{r}
unloadModel()
invisible(file.remove(file))
```
